{# forms/product_cover_field.html #}
<div class="{% if error %}{{ field.error_class }}{% endif %}">
    <input type="file" class="form-control {% if error %}is-invalid{% endif %}" id="{{ field.id }}"
           name="{{ field.id }}" {{ field.input_params() | safe }}
           accept="image/jpeg,image/png,image/webp,image/gif" />
    {% if field.help_text %}
        <small class="form-hint">{{ field.help_text }}</small>
    {% endif %}
</div>

<div id="{{ field.id }}-preview" class="mt-3" style="display: none;">
    <p class="mb-2 fw-bold">{{ _("Новая обложка:") }}</p>
    <div id="{{ field.id }}-preview-container" class="d-flex align-items-center gap-3"></div>
</div>

{% include "forms/_error.html" %}

{% if data and data.filename %}
    <div class="mt-3 border p-3 rounded">
        <p class="mb-2 fw-bold">{{ _("Текущая обложка:") }}</p>
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <img src="{{ data.url | default('#') }}"
                     alt="{{ data.filename }}"
                     style="max-height: 100px; max-width: 150px; object-fit: cover;"
                     class="img-thumbnail me-3">
                <span class="text-decoration-none">
                    {{ data.filename }}
                </span>
            </div>

            <div class="form-check">
                <input id="{{ field.id }}-delete"
                       name="_cover-delete"
                       class="form-check-input"
                       type="checkbox"
                       value="on">
                <label class="form-check-label" for="{{ field.id }}-delete">
                    {{ _("Удалить") }}
                </label>
            </div>
        </div>
    </div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const fieldId = "{{ field.id }}";
    const fileInput = document.getElementById(fieldId);
    const previewContainer = document.getElementById(fieldId + '-preview-container');
    const previewSection = document.getElementById(fieldId + '-preview');

    if (fileInput && previewContainer) {
        fileInput.addEventListener('change', function(e) {
            previewContainer.innerHTML = '';

            if (this.files && this.files.length > 0) {
                previewSection.style.display = 'block';

                const file = this.files[0];
                const reader = new FileReader();
                const previewItem = document.createElement('div');
                previewItem.className = 'text-center position-relative';
                previewItem.style.width = '150px';

                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = file.name;
                    img.style.maxHeight = '100px';
                    img.style.maxWidth = '150px';
                    img.style.objectFit = 'cover';
                    img.className = 'img-thumbnail mb-1';

                    const fileName = document.createElement('div');
                    fileName.className = 'small text-muted';
                    fileName.textContent = file.name.length > 20 ?
                        file.name.substring(0, 17) + '...' : file.name;

                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'btn btn-sm btn-danger position-absolute';
                    removeBtn.style.top = '-5px';
                    removeBtn.style.right = '-5px';
                    removeBtn.style.width = '20px';
                    removeBtn.style.height = '20px';
                    removeBtn.style.padding = '0';
                    removeBtn.style.fontSize = '12px';
                    removeBtn.innerHTML = '×';

                    removeBtn.addEventListener('click', function() {
                        fileInput.value = '';
                        previewSection.style.display = 'none';
                    });

                    previewItem.appendChild(removeBtn);
                    previewItem.appendChild(img);
                    previewItem.appendChild(fileName);
                };

                reader.readAsDataURL(file);
                previewContainer.appendChild(previewItem);
            } else {
                previewSection.style.display = 'none';
            }
        });
    }
});
</script>